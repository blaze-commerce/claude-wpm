name: Create Release Package

on:
  push:
    tags:
      - 'v*'  # Triggers on any tag starting with 'v' (e.g., v1.0.0, v1.0.1)

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  # Run security checks first
  security:
    uses: ./.github/workflows/security-check.yml

  build:
    runs-on: ubuntu-latest
    needs: security  # Only build if security checks pass

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.VERSION }}"
            CHANGELOG=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD | head -20)
          else
            echo "No previous tag found, using recent commits"
            CHANGELOG=$(git log --pretty=format:"- %s" -10)
          fi

          # Write to file for multi-line output
          echo "$CHANGELOG" > changelog.txt
          echo "Generated changelog:"
          cat changelog.txt

      - name: Create deployment zip
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          echo "Version: ${{ steps.version.outputs.VERSION }}"

          # Create .claude directory structure for deployment
          mkdir -p deploy-staging/.claude

          # Copy files to staging (excluding dev/test folders)
          rsync -av --exclude='.git/' \
                    --exclude='qa/' \
                    --exclude='cache/' \
                    --exclude='plans/' \
                    --exclude='.github/' \
                    --exclude='docs/qa-report/' \
                    --exclude='node_modules/' \
                    --exclude='settings.local.json' \
                    --exclude='.DS_Store' \
                    --exclude='*.swp' \
                    --exclude='*.swo' \
                    --exclude='deploy-staging/' \
                    --exclude='changelog.txt' \
                    . deploy-staging/.claude/

          # Show what's being packaged
          echo "ðŸ“‹ Contents of deploy package:"
          du -sh deploy-staging/.claude/*/
          du -sh deploy-staging/.claude/

          # Create zip from staging directory
          cd deploy-staging
          zip -r ../claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip .claude
          cd ..

          # Also create a "latest" copy
          cp claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip claude-wpm-deploy.zip

          echo "âœ… Created packages:"
          ls -la claude-wpm-deploy*.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.VERSION }}
          body_path: changelog.txt
          files: |
            claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip
            claude-wpm-deploy.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ“¦ Release Package Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files attached:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip\` (versioned)" >> $GITHUB_STEP_SUMMARY
          echo "- \`claude-wpm-deploy.zip\` (latest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Excluded from package:**" >> $GITHUB_STEP_SUMMARY
          echo "- qa/ (test files)" >> $GITHUB_STEP_SUMMARY
          echo "- cache/ (runtime cache)" >> $GITHUB_STEP_SUMMARY
          echo "- plans/ (planning files)" >> $GITHUB_STEP_SUMMARY
          echo "- .github/ (workflows)" >> $GITHUB_STEP_SUMMARY

name: Create Release Package

on:
  release:
    types: [created]

jobs:
  # Run security checks first
  security:
    uses: ./.github/workflows/security-check.yml

  build:
    runs-on: ubuntu-latest
    needs: security  # Only build if security checks pass

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create deployment zip
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          echo "Version: ${{ steps.version.outputs.VERSION }}"

          zip -r claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip .claude \
            -x ".claude/qa/*" \
            -x ".claude/cache/*" \
            -x ".claude/plans/*" \
            -x ".claude/settings.local.json" \
            -x ".claude/.github/*" \
            -x "*.DS_Store" \
            -x "*.swp" \
            -x "*.swo"

          # Also create a "latest" copy
          cp claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip claude-wpm-deploy.zip

          echo "âœ… Created packages:"
          ls -la claude-wpm-deploy*.zip

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip
            claude-wpm-deploy.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸ“¦ Release Package Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files attached:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip\` (versioned)" >> $GITHUB_STEP_SUMMARY
          echo "- \`claude-wpm-deploy.zip\` (latest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Excluded from package:**" >> $GITHUB_STEP_SUMMARY
          echo "- qa/ (test files)" >> $GITHUB_STEP_SUMMARY
          echo "- cache/ (runtime cache)" >> $GITHUB_STEP_SUMMARY
          echo "- plans/ (planning files)" >> $GITHUB_STEP_SUMMARY
          echo "- .github/ (workflows)" >> $GITHUB_STEP_SUMMARY

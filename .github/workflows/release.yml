name: Create Release Package

on:
  push:
    tags:
      - 'v*'  # Triggers on any tag starting with 'v' (e.g., v1.0.0, v1.0.1)

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  # Run security checks first
  security:
    uses: ./.github/workflows/security-check.yml

  build:
    runs-on: ubuntu-latest
    needs: security  # Only build if security checks pass

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.VERSION }}"
            CHANGELOG=$(git log --pretty=format:"- %s" $PREV_TAG..HEAD | head -20)
          else
            echo "No previous tag found, using recent commits"
            CHANGELOG=$(git log --pretty=format:"- %s" -10)
          fi

          # Write to file for multi-line output
          echo "$CHANGELOG" > changelog.txt
          echo "Generated changelog:"
          cat changelog.txt

      - name: Create deployment zip
        run: |
          echo "üì¶ Creating deployment package..."
          echo "Version: ${{ steps.version.outputs.VERSION }}"

          # Create .claude directory structure for deployment
          mkdir -p deploy-staging/.claude

          # Copy files to staging (excluding [REPO] and [GHP] files)
          rsync -av --exclude='.git/' \
                    --exclude='qa/' \
                    --exclude='cache/' \
                    --exclude='plans/' \
                    --exclude='.github/' \
                    --exclude='docs/' \
                    --exclude='node_modules/' \
                    --exclude='settings.local.json' \
                    --exclude='README.md' \
                    --exclude='CONTRIBUTING.md' \
                    --exclude='LICENSE' \
                    --exclude='FILE_MAPPING.md' \
                    --exclude='.gitignore' \
                    --exclude='scripts/create-deploy-zip.sh' \
                    --exclude='scripts/verify-deploy-zip.sh' \
                    --exclude='.DS_Store' \
                    --exclude='*.swp' \
                    --exclude='*.swo' \
                    --exclude='deploy-staging/' \
                    --exclude='changelog.txt' \
                    . deploy-staging/.claude/

          # Show what's being packaged
          echo "üìã Contents of deploy package:"
          du -sh deploy-staging/.claude/*/
          du -sh deploy-staging/.claude/

          # Create zip from staging directory
          cd deploy-staging
          zip -r ../claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip .claude
          cd ..

          # Also create a "latest" copy
          cp claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip claude-wpm-deploy.zip

          echo "‚úÖ Created packages:"
          ls -la claude-wpm-deploy*.zip

      - name: Verify deploy zip contents
        run: |
          echo "üîç Verifying deploy zip contents..."
          echo "üìã Reading required files from FILE_MAPPING.md (single source of truth)"
          echo ""

          # Get zip contents
          ZIP_CONTENTS=$(unzip -l claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip | tail -n +4 | head -n -2 | awk '{print $4}')

          ERRORS=0

          # Read required files from FILE_MAPPING.md - extract [WPM] labeled files
          echo "Checking required files (from FILE_MAPPING.md [WPM] entries)..."
          while IFS= read -r line; do
            # Remove "- " prefix and " [WPM]" suffix
            file=$(echo "$line" | sed 's/^- //' | sed 's/ \[WPM\]$//')
            if [[ -n "$file" ]]; then
              # Prepend .claude/ for zip path
              zip_path=".claude/$file"
              if echo "$ZIP_CONTENTS" | grep -q "^${zip_path}$"; then
                echo "  ‚úì $zip_path"
              else
                echo "  ‚úó MISSING: $zip_path"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done < <(grep '\[WPM\]$' FILE_MAPPING.md | grep -v '^\s*#')

          # Check forbidden files are NOT included (these are [REPO] and [GHP] files)
          echo ""
          echo "Checking for forbidden files..."
          FORBIDDEN_PATTERNS=(
            ".claude/qa/"
            ".claude/plans/"
            ".claude/cache/"
            ".github/"
            "docs/"
            "node_modules/"
            ".claude/CONTRIBUTING.md"
            ".claude/LICENSE"
            ".claude/FILE_MAPPING.md"
            ".gitignore"
          )

          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if echo "$ZIP_CONTENTS" | grep -q "^${pattern}"; then
              echo "  ‚úó FORBIDDEN files found: $pattern"
              ERRORS=$((ERRORS + 1))
            else
              echo "  ‚úì No $pattern"
            fi
          done

          echo ""
          if [ "$ERRORS" -gt 0 ]; then
            echo "‚ùå Verification FAILED with $ERRORS errors"
            exit 1
          else
            echo "‚úÖ Verification PASSED"
            echo ""
            echo "Zip contents:"
            unzip -l claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.VERSION }}
          body_path: changelog.txt
          files: |
            claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip
            claude-wpm-deploy.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## üì¶ Release Package Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files attached:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`claude-wpm-deploy-${{ steps.version.outputs.VERSION }}.zip\` (versioned)" >> $GITHUB_STEP_SUMMARY
          echo "- \`claude-wpm-deploy.zip\` (latest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Excluded from package:**" >> $GITHUB_STEP_SUMMARY
          echo "- qa/ (test files)" >> $GITHUB_STEP_SUMMARY
          echo "- cache/ (runtime cache)" >> $GITHUB_STEP_SUMMARY
          echo "- plans/ (planning files)" >> $GITHUB_STEP_SUMMARY
          echo "- .github/ (workflows)" >> $GITHUB_STEP_SUMMARY
